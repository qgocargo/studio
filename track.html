<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Delivery - Q'go Cargo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .qg-logo { font-weight: 800; color: #243c5a; }
        .qg-logo span { color: #52a39a; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- 
      TODO: PASTE YOUR FIREBASE CONFIG HERE 
      This object is found in your Firebase project settings.
    -->
    <script>
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
      };
    </script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, getDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const podContent = document.getElementById('pod-content');
        const loadingSpinner = document.getElementById('loading-spinner');
        const notFoundMessage = document.getElementById('not-found');

        async function fetchPodData() {
            const urlParams = new URLSearchParams(window.location.search);
            const podId = urlParams.get('id');

            if (!podId) {
                loadingSpinner.classList.add('hidden');
                notFoundMessage.classList.remove('hidden');
                return;
            }

            try {
                const podRef = doc(db, 'pods', podId);
                const podSnap = await getDoc(podRef);

                if (podSnap.exists()) {
                    renderPodData(podSnap.data());
                } else {
                    notFoundMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error fetching POD:", error);
                notFoundMessage.innerText = "An error occurred while fetching the delivery details.";
                notFoundMessage.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }
        
        function renderPodData(data) {
            const { jobFileData, receiverName, completedAt, deliveryLocation, signatureDataUrl, photoUrls } = data;
            
            const kuwaitTime = new Date(completedAt.seconds * 1000).toLocaleString('en-US', { timeZone: 'Asia/Kuwait' });
            
            document.getElementById('jfn').innerText = jobFileData.jfn || 'N/A';
            document.getElementById('mawb').innerText = jobFileData.mawb || 'N/A';
            document.getElementById('shipper').innerText = jobFileData.sh || 'N/A';
            document.getElementById('consignee').innerText = jobFileData.co || 'N/A';
            document.getElementById('description').innerText = jobFileData.dsc || 'N/A';
            document.getElementById('delivered-to').innerText = receiverName || 'N/A';
            document.getElementById('delivery-date').innerText = kuwaitTime;
            document.getElementById('delivery-location').innerText = deliveryLocation || 'N/A';

            const signatureImg = document.getElementById('signature-img');
            if (signatureDataUrl) {
                signatureImg.src = signatureDataUrl;
                signatureImg.classList.remove('hidden');
            }

            const photosContainer = document.getElementById('photos-container');
            if (photoUrls && photoUrls.length > 0) {
                photoUrls.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = "w-full h-auto rounded-lg shadow-md";
                    img.alt = "Delivery Photo";
                    photosContainer.appendChild(img);
                });
                photosContainer.classList.remove('hidden');
            }

            podContent.classList.remove('hidden');
        }

        fetchPodData();
    </script>
    
    <div class="container mx-auto max-w-2xl p-4">
        <header class="text-center my-6">
            <h1 class="qg-logo text-4xl">Q'go<span>Cargo</span></h1>
            <p class="text-gray-600 text-lg mt-2">Proof of Delivery</p>
        </header>

        <div id="loading-spinner" class="text-center py-10">
            <svg class="animate-spin h-8 w-8 text-slate-800 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-gray-500">Loading delivery details...</p>
        </div>

        <div id="not-found" class="text-center py-10 hidden">
            <p class="text-xl text-red-600">Delivery Not Found</p>
            <p class="text-gray-500 mt-2">The tracking ID is invalid or the delivery does not exist.</p>
        </div>
        
        <main id="pod-content" class="bg-white rounded-lg shadow-lg p-6 space-y-6 hidden">
            <!-- Job Details -->
            <div class="border-b pb-4">
                <h2 class="text-xl font-bold mb-4">Job Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div><strong class="text-gray-500 block">Job File No:</strong> <span id="jfn"></span></div>
                    <div><strong class="text-gray-500 block">MAWB:</strong> <span id="mawb"></span></div>
                    <div><strong class="text-gray-500 block">Shipper:</strong> <span id="shipper"></span></div>
                    <div><strong class="text-gray-500 block">Consignee:</strong> <span id="consignee"></span></div>
                    <div class="col-span-2"><strong class="text-gray-500 block">Description:</strong> <span id="description"></span></div>
                </div>
            </div>

            <!-- Delivery Confirmation -->
            <div>
                <h2 class="text-xl font-bold mb-4">Delivery Confirmation</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div><strong class="text-gray-500 block">Delivered To:</strong> <span id="delivered-to"></span></div>
                    <div><strong class="text-gray-500 block">Date & Time (Kuwait):</strong> <span id="delivery-date"></span></div>
                    <div class="col-span-2"><strong class="text-gray-500 block">Location:</strong> <span id="delivery-location"></span></div>
                </div>
            </div>

            <!-- Signature -->
            <div class="pt-4 border-t">
                <h3 class="font-bold mb-2">Receiver's Signature</h3>
                <div class="bg-gray-100 p-2 rounded-md inline-block">
                    <img id="signature-img" src="" alt="Receiver's Signature" class="hidden">
                </div>
            </div>

            <!-- Photos -->
            <div id="photos-container" class="pt-4 border-t hidden space-y-4">
                <h3 class="font-bold mb-2">Delivery Photos</h3>
            </div>
        </main>

        <footer class="text-center text-xs text-gray-400 mt-8">
            <p>&copy; 2024 Q'go Cargo. All rights reserved.</p>
        </footer>
    </div>
</body>
</html>
